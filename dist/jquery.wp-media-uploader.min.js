
(function($){$.fn.wp_media_uploader=function(options)
{if(typeof options==='string'){if(window.media_uploaders===undefined)
throw'001: No Media Uploader has been initialized';var id=$(this).attr('id');if(window.media_uploaders[id]===undefined)
throw'002: No Media Uploader has been initialized on DOM element #'+id;if(window.media_uploaders[id][options]===undefined||typeof window.media_uploaders[id][options]!=='function')
throw'003: Function call does not exist';window.media_uploaders[id][options]();}
var self=this;self.$el=$(this);var frame=undefined;self.$target=undefined;self.templates={image:undefined,video:undefined,file:undefined,embed:undefined,};self.options=$.extend({name:self.$el.attr('name')||undefined,value:self.$el.attr('value')||undefined,editor:self.$el.data('editor')||undefined,target:self.$el.data('target')||'after',render:self.$el.data('render')!==undefined?self.$el.data('render'):true,multiple:self.$el.attr('multiple')!==undefined?self.$el.attr('multiple'):false,clearOnSelection:self.$el.data('clear-on-selection')!==undefined?self.$el.data('clear-on-selection'):true,templateImage:self.$el.data('template-image')||undefined,templateVideo:self.$el.data('template-video')||undefined,templateFile:self.$el.data('template-file')||undefined,templateEmbed:self.$el.data('template-embed')||undefined,title:self.$el.data('title')||undefined,buttonText:self.$el.data('button')||undefined,mimeType:self.$el.data('type')||undefined,size:self.$el.data('size')||undefined,allowClose:self.$el.data('allow-close')!==undefined?self.$el.data('allow-close'):true,success:undefined,mediaFilter:undefined,mediaMap:undefined,idValue:self.$el.data('id-value')!==undefined?self.$el.data('id-value'):true,showInput:self.$el.data('show-input')!==undefined?self.$el.data('show-input'):false,inputCssClass:self.$el.data('input-class')||undefined,targetCssClass:self.$el.data('target-class')||undefined,mediaLoad:self.$el.data('media-load')!==undefined?(self.$el.data('media-load')?self.$el.data('media-load'):undefined):'wp.api',},options);self.uniqid=function(prefix,more_entropy)
{var id=Date.now()/1000;id=id.toString(16).split('.').join('');while(id.length<14){id+='0';}
var more='';if(more_entropy!==undefined&&more_entropy===true){more='.'+Math.round(Math.random()*100000000);}
return(prefix!==undefined?prefix:'')+id+more;};self.ready=function()
{if(window.media_uploaders===undefined)
window.media_uploaders={};if(self.$el.attr('id')===undefined)
self.$el.attr('id','uploader-'+self.uniqid());self.frame=wp.media.frames[self.$el.attr('id')]=wp.media({title:self.options.title,library:self.options.mimeType?{type:self.options.mimeType}:undefined,button:{text:self.options.buttonText,close:self.options.allowClose,},multiple:self.options.multiple,});switch(self.options.target){case'before':var target_id='uploader-target-'+self.uniqid();$('<div id="'+target_id+'"></div>').insertBefore(self.$el);self.$target=$('#'+target_id);break;case'after':var target_id='uploader-target-'+self.uniqid();$('<div id="'+target_id+'"></div>').insertAfter(self.$el);self.$target=$('#'+target_id);break;case'inside':self.$target=self.$el;break;default:if($(self.options.target).length)
self.$target=$(self.options.target);break;}
if(self.$target===undefined)
return;if(self.options.targetCssClass)
self.$target.addClass(self.options.targetCssClass);var $template=undefined;if(self.options.templateImage){$template=$(self.options.templateImage);if($template.length)
self.templates.image=$template.html();}
if(self.options.templateVideo){$template=$(self.options.templateVideo);if($template.length)
self.templates.video=$template.html();}
if(self.options.templateFile){$template=$(self.options.templateVideo);if($template.length)
self.templates.file=$template.html();}
if(self.options.templateEmbed){$template=$(self.options.templateVideo);if($template.length)
self.templates.embed=$template.html();}
self.set_default_templates();if(!self.options.multiple)
self.options.clearOnSelection=true;self.$el.on('click',self.on_click);self.frame.on('select',self.on_select);if(self.options.value){self.options.value=self.options.value.split(',');if(self.options.mediaLoad){switch(self.options.mediaLoad){case'wp.api':self.load_attachments(self.options.value);break;default:window[self.options.mediaLoad](self,self.options.value);break;}}}
self.$el.trigger('uploader:ready',[self.options.value,self]);};self.destroy=function()
{self.$target.remove();self.frame.detach();window.media_uploaders[self.$el.attr('id')]=undefined;self=undefined;};self.on_click=function(event)
{event.preventDefault();if(self.$el.is(':disabled')||self.$el.hasClass('loading'))
return;self.$el.trigger('uploader:open',[self]);self.frame.open();};self.render=function(media)
{if(!self.options.render)return;self.$el.trigger('uploader:render.before',[self]);if(self.$target){if(self.options.clearOnSelection)
self.$target.html('');$.each(media,function(i){if(self.$target.find('#'+this.id).length)
return;self.$target.append(self.render_media(this));});}
self.$el.trigger('uploader:render.after',[self]);self.$el.trigger('uploader:render');}
self.render_media=function(media)
{$html=$(self.templates[media.type]);$html.attr('id',media.id);$html.find('input').attr('type',self.options.showInput?'text':'hidden');if(self.options.name)
$html.find('input').attr('name',self.options.name+(self.options.multiple?'[]':''));if(!self.options.idValue&&media.url)
$html.find('input').attr('value',media.url);if(self.options.idValue&&media.id)
$html.find('input').attr('value',media.id);if(self.options.inputCssClass)
$html.find('input').addClass(self.options.inputCssClass);switch(media.type){case'embed':case'image':$html.find('img').attr('src',media.url);if(media.alt)
$html.find('img').attr('alt',media.alt);$html.find('img').css('max-width','100%');$html.find('img').css('width','auto');$html.find('img').css('height','auto');break;case'video':$html.find('source').attr('src',media.url);break;}
return $html.get();}
self.parse_capture=function(models)
{var attachments=[];for(var i in models){var media={_model:models[i],id:models[i].id,type:models[i].get('type'),subtype:models[i].get('subtype'),mime:models[i].get('mime'),url:models[i].get('url'),};if(models[i].get('alt'))
media.alt=models[i].get('alt');if(self.options.size&&models[i].get('sizes')&&models[i].get('sizes')[self.options.size])
media.url=models[i].get('sizes')[self.options.size].url;if(models[i].get('image'))
media.img=models[i].get('image').src;if(models[i].get('title'))
media.title=models[i].get('title');if(models[i].get('filename'))
media.filename=models[i].get('filename');if(media.type!=='image'&&media.type!=='video'&&media.type!=='embed'){media.type='file';}
attachments.push(media);}
if(self.options.mediaFilter){attachments=attachments.filter(self.options.mediaFilter);}
if(self.options.mediaMap){attachments=attachments.map(self.options.mediaMap);}
if(!self.options.multiple&&attachments.length>1){while(attachments.length>1){attachments.pop();}}
self.$el.trigger('uploader:attachments',[attachments,self]);self.render(attachments);if(self.options.success){self.options.success(attachments);}};self.set_default_templates=function()
{if(self.templates.image===undefined){self.templates.image='<div class="attachment type-image"><img><input type="text"/></div>';}
if(self.templates.video===undefined){self.templates.video='<div class="attachment type-video"><video controls><source type="video/mp4"></video><input type="text"/></div>';}
if(self.templates.file===undefined){self.templates.file='<div class="attachment type-file"><input type="text"/></div>';}
if(self.templates.embed===undefined){self.templates.embed='<div class="attachment type-embed"><img><input type="text"/></div>';}};self.on_select=function()
{var selection=self.frame.state().get('selection');self.parse_capture(selection.models);self.$el.trigger('uploader:selection',[selection.models,self]);};self.load_attachments=function(values)
{var ids=values.filter(function(id){return!isNaN(id);}).map(function(id){return id.trim();});if(wp&&wp.api&&ids.length){self.$el.prop('disabled',true);self.$el.addClass('loading');self.$el.attr('disabled','disabled');wp.apiRequest({path:'wp/v2/media',method:'GET',data:{include:ids,per_page:100,},}).then(self.on_load_attachments);}else if(values.length){var attachments=[];for(var i in values){attachments.push({_model:undefined,id:1,type:'file',mime:undefined,subtype:undefined,url:values[i],});}
self.render(attachments);}};self.on_load_attachments=function(data)
{var attachments=[];for(var i in data){var media={_model:undefined,id:data[i].id,type:data[i].media_type,mime:data[i].mime_type,subtype:data[i].mime_type.replace(/[a-zA-Z0-9]+\//g,''),url:data[i].guid.rendered?data[i].guid.rendered:data[i].guid,};if(data[i].alt_text)
media.alt=data[i].alt_text;if(self.options.size&&data[i].media_details&&data[i].media_details.sizes&&data[i].media_details.sizes[self.options.size])
media.url=data[i].media_details.sizes[self.options.size].source_url;if(media.type!=='image')
media.type=data[i].mime_type.replace(/\/[a-zA-Z0-9]+/g,'');if(media.type!=='image'&&media.type!=='video'&&media.type!=='embed'){media.type='file';}
attachments.push(media);}
self.render(attachments);self.$el.prop('disabled',false);self.$el.removeAttr('disabled');self.$el.removeClass('loading');};self.ready();window.media_uploaders[self.$el.attr('id')]=self;return self;};$(document).ready(function(){$('*[role="media-uploader"][data-editor]').each(function(){$(this).wp_media_uploader();});});})(jQuery);